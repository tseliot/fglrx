#!/bin/sh
# Copyright (C) 2007 Mario Limonciello
# Copyright (C) 2009-2011 Canonical Ltd.

set -e

PACKAGE_NAME=#DRIVERNAME#
CVERSION=`dpkg-query -W -f='${Version}' $PACKAGE_NAME | awk -F "-" '{print $1}' | cut -d\: -f2`

ARCH=`dpkg --print-architecture`

CORE_SPLIT_RELEASE="2:14.502-0ubuntu1"

restore_fglrx_core() {
    BACKUP_DIR=#CORERESTOREDIR#
    if [ -d $BACKUP_DIR ]; then
        for elem in \
            /usr/bin/atiode \
            /usr/bin/clinfo \
            /usr/bin/atieventsd \
            /etc/OpenCL/vendors/amdocl32.icd \
            /etc/OpenCL/vendors/amdocl64.icd \
            /usr/lib/libaticalcl.so \
            /usr/lib/libatiuki.so.1.0 \
            /usr/lib/libaticalrt.so \
            /usr/lib/libatiadlxx.so \
            /usr/lib/libamdocl12cl64.so \
            /usr/lib/libOpenCL.so.1 \
            /usr/lib/libamdocl64.so \
            /usr/lib/libaticaldd.so \
            /usr/lib/libatiuki.so.1 \
            /usr/lib32/libamdocl32.so \
            /usr/lib32/libaticalcl.so \
            /usr/lib32/libatiuki.so.1.0 \
            /usr/lib32/libaticalrt.so \
            /usr/lib32/libatiadlxx.so \
            /usr/lib32/libamdocl12cl32.so \
            /usr/lib32/libOpenCL.so.1 \
            /usr/lib32/libaticaldd.so \
            /usr/lib32/libatiuki.so.1 \
            /etc/ati; do
        if [ -e "$BACKUP_DIR/$elem" ]; then
            echo "Restoring $elem"
            cp -aRf $BACKUP_DIR/$elem $elem 2>/dev/null || true
        fi
        done
    fi
}

restore_fglrx() {
    BACKUP_DIR=#RESTOREDIR#
    if [ -d $BACKUP_DIR ]; then
        for elem in \
            /usr/bin/amdconfig \
            /usr/bin/atiode \
            /usr/bin/aticonfig \
            /usr/bin/fglrxinfo \
            /usr/bin/fgl_glxgears \
            /usr/lib/libAMDXvBA.cap \
            /usr/lib32/fglrx/libAMDXvBA.cap \
            /usr/lib/dri/fglrx_dri.so \
            /usr/lib32/fglrx/dri/fglrx_dri.so; do
        if [ -e "$BACKUP_DIR/$elem" ]; then
            echo "Restoring $elem"
            cp -aRf $BACKUP_DIR/$elem $elem 2>/dev/null || true
        fi
        done
    fi
}

restore_fglrx_amdcccle() {
    BACKUP_DIR=#AMDCCCLERESTOREDIR#
    if [ -d $BACKUP_DIR ]; then
        for elem in \
            /usr/bin/amdupdaterandrconfig \
            /usr/bin/amdxdg-su \
            /usr/bin/amdcccle; do
        if [ -e "$BACKUP_DIR/$elem" ]; then
            echo "Restoring $elem"
            cp -aRf $BACKUP_DIR/$elem $elem 2>/dev/null || true
        fi
        done
    fi
}


if [ "$1" = "configure" ]; then

    #check whether libglx.so got installed.  some releases earlier than x740
    #will not actually have this libglx.so
    if [ ! -f /usr/lib/xorg/modules/extensions/libglx.so ]; then
        dpkg-divert --remove --rename --package xorg-driver-fglrx --divert /usr/lib/fglrx/libglx.so.xlibmesa /usr/lib/xorg/modules/extensions/libglx.so > /dev/null
    fi

    # Clean up any previous non-multi-arch alternatives
    if [ -n "$(update-alternatives --list gl_conf 2>/dev/null)" ]; then
        set -a $(update-alternatives --list gl_conf 2>/dev/null)
        while [ $# -ge 1 ] && [ "$#" != "configure" ]; do
            ALTERNATIVE=${1}
            update-alternatives --remove gl_conf $ALTERNATIVE
            shift
        done
    fi

    # Try to restore the files from fglrx-core (see LP: #1511301)
    if [ -d #CORERESTOREDIR# ]; then
        # Try to restore fglrx-core
        restore_fglrx_core

        # Move ati before the alternatives are updated
        mv /etc/ati /etc/ati.dpkg-temp
    fi

    update-alternatives --force \
        --install /#SYSCONFDIR#/ld.so.conf.d/#DEB_HOST_MULTIARCH#_GL.conf #DEB_HOST_MULTIARCH#_gl_conf /#LDSOCONF# #ALTPRIORITY# \
        --slave /#DATADIR#/applications/ubuntu-amdcccle.desktop #DEB_HOST_MULTIARCH#_amdcccle_desktop /#PKGDATADIR#/amdcccle.desktop \
        --slave /#DATADIR#/applications/ubuntu-amdccclesu.desktop #DEB_HOST_MULTIARCH#_amdccclesu_desktop /#PKGDATADIR#/amdccclesu.desktop \
        --slave /#LIBDIR#/xorg/modules/drivers/fglrx_drv.so #DEB_HOST_MULTIARCH#_fglrx_drv /#PKGLIBDIR#/xorg/modules/drivers/fglrx_drv.so \
        --slave /#SYSCONFDIR#/X11/Xsession.d/10fglrx #DEB_HOST_MULTIARCH#_10fglrx /#PKGLIBDIR#/10fglrx \
        --slave /#XORGEXTRA# #DEB_HOST_MULTIARCH#_xorg_extra_modules /#PKGLIBDIR#/xorg \

    # This is for switchable graphics
    # Note: the radeon kernel module is still blacklisted
    update-alternatives --force \
        --install /#SYSCONFDIR#/ld.so.conf.d/#DEB_HOST_MULTIARCH#_GL.conf #DEB_HOST_MULTIARCH#_gl_conf /#PXLDSOCONF# #PXALTPRIORITY# \
        --slave /#DATADIR#/applications/ubuntu-amdcccle.desktop #DEB_HOST_MULTIARCH#_amdcccle_desktop /#PKGDATADIR#/amdcccle.desktop \
        --slave /#DATADIR#/applications/ubuntu-amdccclesu.desktop #DEB_HOST_MULTIARCH#_amdccclesu_desktop /#PKGDATADIR#/amdccclesu.desktop \
        --slave /#LIBDIR#/xorg/modules/drivers/fglrx_drv.so #DEB_HOST_MULTIARCH#_fglrx_drv /#PKGLIBDIR#/xorg/modules/drivers/fglrx_drv.so \
        --slave /#SYSCONFDIR#/X11/Xsession.d/10fglrx #DEB_HOST_MULTIARCH#_10fglrx /#PKGLIBDIR#/10fglrx \
        --slave /#XORGEXTRA# #DEB_HOST_MULTIARCH#_xorg_extra_modules /#PXDIR#/xorg \

    # Install just the ld.so.conf.d alternatives for the secondary architecture.
    # We need only to ensure that any mesa ld.so.conf.d alternative isn't active.
    update-alternatives --force \
        --install /#SYSCONFDIR#/ld.so.conf.d/#OTHER_ARCH#_GL.conf #OTHER_ARCH#_gl_conf /#ALTLDSOCONF# #ALTPRIORITY#
    update-alternatives --force \
        --install /#SYSCONFDIR#/ld.so.conf.d/#OTHER_ARCH#_GL.conf #OTHER_ARCH#_gl_conf /#ALTPXLDSOCONF# #PXALTPRIORITY#

    # ldconfig needs to be run immediately as we're changing /etc/ld.so.conf.d/ with
    # alternatives.
    LDCONFIG_NOTRIGGER=y ldconfig

    # Try to restore the files from fglrx and fglrx-amdcccle (see LP: #1511301)
    if [ -d #CORERESTOREDIR# ]; then
        # Move ati back
        mv /etc/ati.dpkg-temp /etc/ati

        restore_fglrx
        restore_fglrx_amdcccle

        rm -Rf #CORERESTOREDIR#
    fi
fi

#DEBHELPER#
